<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circulation Nancy</title>
  <link rel="stylesheet" href="css/velos.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
</head>
<body>

<header>
  <h1>Circulation Nancy</h1>
</header>

<main>
  <section id="decision-section">
    <h2>Chargement...</h2>
  </section>

  <section id="meteo-section">
    <h2>Météo</h2>
    <p id="meteo">Chargement...</p>
  </section>

  <section id="pollution-section">
    <h2>Qualité de l'air</h2>
    <p id="pollution">Chargement...</p>
  </section>

  <section id="stations-section">
    <h2>Stations vélos disponibles</h2>
    <ul id="stations">
      <li>Chargement...</li>
    </ul>
  </section>

  <div style='height: 500px; margin-bottom: 2em; width:75%; margin-left:auto; margin-right:auto' id='map'></div>

  <section id="sources-section">
    <h2>Sources / Liens API</h2>
    <ul id="sources">
      <li><strong>IP :</strong> https://ipapi.co/json/</li>
      <li><strong>Météo :</strong> https://www.infoclimat.fr/public-api/gfs/xml?_ll=${lat},${lon}&_auth=ARsDFFIsBCZRfFtsD3lSe1Q8ADUPeVRzBHgFZgtuAH1UMQNgUTNcPlU5VClSfVZkUn8AYVxmVW0Eb1I2WylSLgFgA25SNwRuUT1bPw83UnlUeAB9DzFUcwR4BWMLYwBhVCkDb1EzXCBVOFQoUmNWZlJnAH9cfFVsBGRSPVs1UjEBZwNkUjIEYVE6WyYPIFJjVGUAZg9mVD4EbwVhCzMAMFQzA2JRMlw5VThUKFJiVmtSZQBpXGtVbwRlUjVbKVIuARsDFFIsBCZRfFtsD3lSe1QyAD4PZA%3D%3D&_c=19f3aa7d766b6ba91191c8be71dd1ab2</li>
      <li><strong>Pollution :</strong> https://services3.arcgis.com/Is0UwT37raQYl9Jj/arcgis/rest/services/ind_grandest/FeatureServer/0/query?where=lib_zone%3D'Nancy'&outFields=*&returnGeometry=true&f=pjson</li>
      <li><strong>Vélos :</strong> https://api.cyclocity.fr/contracts/nancy/gbfs/gbfs.json</li>
      <li><strong>Dépôt git :</strong> https://github.com/bocchiarati/interoperabilite</li>
    </ul>
  </section>

</main>

<script src="js/velos.js"></script>
<script>
  async function initMap() {
    const geoResp = await fetch("https://ipapi.co/json/");
    const geo = await geoResp.json();
    let lat, lon;
    const ville = geo.city;

    if (ville !== "Nancy") {
      lat = 48.68298;
      lon = 6.16095;
    } else {
      lat = geo.latitude;
      lon = geo.longitude;
    }

    const map = L.map('map').setView([lat, lon], 14);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    //placer le client
    L.marker([lat, lon]).addTo(map).bindPopup("Vous êtes ici").openPopup();


    const gbfsResp = await fetch("https://api.cyclocity.fr/contracts/nancy/gbfs/gbfs.json");
    const gbfs = await gbfsResp.json();
    const feeds = gbfs.data.fr.feeds;

    const stationInfoUrl = feeds.find(f => f.name === "station_information").url;
    const stationStatusUrl = feeds.find(f => f.name === "station_status").url;

    const stationInfoResp = await fetch(stationInfoUrl);
    const stationInfo = await stationInfoResp.json();

    const stationStatusResp = await fetch(stationStatusUrl);
    const stationStatus = await stationStatusResp.json();

    //liaison
    const stations = stationInfo.data.stations.map(st => {
      const status = stationStatus.data.stations.find(s => s.station_id === st.station_id);
      return {
        name: st.name,
        lat: st.lat,
        lon: st.lon,
        bikes: status ? status.num_bikes_available : 0,
        docks: status ? status.num_docks_available : 0
      };
    });

    //creation icon velo
    var veloIcon = L.icon({
      iconUrl: 'image/velo.png',
      iconSize: [40, 40],
      iconAnchor: [22, 94],
      popupAnchor: [-3, -76],
    });

    stations.forEach(st => {
      const marker = L.marker([st.lat, st.lon]).addTo(map);
      marker.bindPopup(`
            <strong>${st.name}</strong><br>
            Vélos disponibles : ${st.bikes}<br>
            Places libres : ${st.docks}
        `).setIcon(veloIcon);
    });
  }

  initMap().catch(err => console.error(err));
</script>
</body>
</html>
